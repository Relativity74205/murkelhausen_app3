{% extends "base.html" %}

{% block title %}Kalender - Murkelhausen Family{% endblock %}

{% block nav_calendar %}active{% endblock %}

{% block extra_css %}
<!-- HTMX -->
<script src="https://unpkg.com/htmx.org@2.0.1"></script>

<style>
    .hero-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 3rem 0;
    }
    .appointment-card {
        transition: transform 0.2s;
        border-left: 4px solid #667eea;
    }
    .appointment-card:hover {
        transform: translateY(-3px);
    }
    .badge-arkadius {
        background-color: #0d6efd;
    }
    .badge-erik {
        background-color: #198754;
    }
    .badge-mattis {
        background-color: #ffc107;
        color: #000;
    }
    .badge-andrea {
        background-color: #d63384;
    }
    .badge-geburtstage {
        background-color: #dc3545;
    }
    .badge-whole-day {
        background-color: #6c757d;
    }
    .badge-recurring {
        background-color: #0dcaf0;
        color: #000;
    }
    .date-header {
        background-color: #f8f9fa;
        border-left: 4px solid #667eea;
        padding: 0.75rem 1rem;
        margin-bottom: 1rem;
        font-weight: bold;
    }
    .field-error {
        border-color: #dc3545 !important;
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
    }
</style>
{% endblock %}

{% block content %}

    <!-- Hero Section -->
    <section class="hero-section">
        <div class="container text-center">
            <h1 class="display-4 mb-3">üìÖ Familienkalender</h1>
            <p class="lead" id="days-text">Termine f√ºr die n√§chsten <span id="days-count">7</span> Tage</p>
            <div class="d-flex justify-content-center gap-3 mt-3 flex-wrap">
                <button type="button" class="btn btn-light btn-lg" data-bs-toggle="modal" data-bs-target="#newAppointmentModal">
                    ‚ûï Neuer Termin
                </button>
                <select class="form-select form-select-lg" id="days-select" style="max-width: 200px;">
                    <option value="3">3 Tage</option>
                    <option value="7" selected>7 Tage</option>
                    <option value="14">14 Tage</option>
                    <option value="30">30 Tage</option>
                    <option value="60">60 Tage</option>
                    <option value="90">90 Tage</option>
                </select>
            </div>
        </div>
    </section>

    <!-- New Appointment Modal -->
    <div class="modal fade" id="newAppointmentModal" tabindex="-1" aria-labelledby="newAppointmentModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="newAppointmentModalLabel">Neuer Termin erstellen</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form hx-post="{% url 'calendar_create' %}"
                      hx-target="#appointment-message"
                      hx-swap="innerHTML">
                    {% csrf_token %}
                    <div class="modal-body">
                        <div id="appointment-message"></div>

                        <div class="mb-3">
                            <label for="calendar" class="form-label">Kalender</label>
                            <select class="form-select" id="calendar" name="calendar" required>
                                <option value="">Bitte w√§hlen...</option>
                                <option value="Arkadius">Arkadius</option>
                                <option value="Familie">Familie</option>
                                <option value="Erik">Erik</option>
                                <option value="Mattis">Mattis</option>
                                <option value="Andrea">Andrea</option>
                                <option value="Geburtstage">Geburtstage</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="event_name" class="form-label">Terminname</label>
                            <input type="text" class="form-control" id="event_name" name="event_name" required>
                        </div>

                        <div class="mb-3">
                            <label for="start_date" class="form-label">Startdatum</label>
                            <input type="date" class="form-control" id="start_date" name="start_date" required>
                        </div>

                        <div class="mb-3">
                            <label for="start_time" class="form-label">Startzeit (optional)</label>
                            <input type="time" class="form-control" id="start_time" name="start_time">
                        </div>

                        <div class="mb-3">
                            <label for="end_date" class="form-label">Enddatum</label>
                            <input type="date" class="form-control" id="end_date" name="end_date" required>
                        </div>

                        <div class="mb-3">
                            <label for="end_time" class="form-label">Endzeit (optional)</label>
                            <input type="time" class="form-control" id="end_time" name="end_time">
                        </div>

                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="is_whole_day" name="is_whole_day">
                            <label class="form-check-label" for="is_whole_day">
                                Ganzt√§gig
                            </label>
                        </div>

                        <div class="mb-3">
                            <label for="description" class="form-label">Beschreibung (optional)</label>
                            <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                        <button type="submit" class="btn btn-primary">Termin erstellen</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Appointment Modal -->
    <div class="modal fade" id="editAppointmentModal" tabindex="-1" aria-labelledby="editAppointmentModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editAppointmentModalLabel">Termin bearbeiten</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form hx-post="{% url 'calendar_update' %}"
                      hx-target="#edit-appointment-message"
                      hx-swap="innerHTML">
                    {% csrf_token %}
                    <div class="modal-body">
                        <div id="edit-appointment-message"></div>

                        <!-- Hidden fields for appointment ID and original calendar -->
                        <input type="hidden" id="edit_appointment_id" name="appointment_id">
                        <input type="hidden" id="edit_original_calendar_name" name="original_calendar_name">

                        <div class="mb-3">
                            <label for="edit_calendar" class="form-label">Kalender</label>
                            <select class="form-select" id="edit_calendar" name="calendar" required>
                                <option value="Arkadius">Arkadius</option>
                                <option value="Familie">Familie</option>
                                <option value="Erik">Erik</option>
                                <option value="Mattis">Mattis</option>
                                <option value="Andrea">Andrea</option>
                                <option value="Geburtstage">Geburtstage</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="edit_event_name" class="form-label">Terminname</label>
                            <input type="text" class="form-control" id="edit_event_name" name="event_name" required>
                        </div>

                        <div class="mb-3">
                            <label for="edit_start_date" class="form-label">Startdatum</label>
                            <input type="date" class="form-control" id="edit_start_date" name="start_date" required>
                        </div>

                        <div class="mb-3">
                            <label for="edit_start_time" class="form-label">Startzeit (optional)</label>
                            <input type="time" class="form-control" id="edit_start_time" name="start_time">
                        </div>

                        <div class="mb-3">
                            <label for="edit_end_date" class="form-label">Enddatum</label>
                            <input type="date" class="form-control" id="edit_end_date" name="end_date" required>
                        </div>

                        <div class="mb-3">
                            <label for="edit_end_time" class="form-label">Endzeit (optional)</label>
                            <input type="time" class="form-control" id="edit_end_time" name="end_time">
                        </div>

                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="edit_is_whole_day" name="is_whole_day">
                            <label class="form-check-label" for="edit_is_whole_day">
                                Ganzt√§gig
                            </label>
                        </div>

                        <div class="mb-3">
                            <label for="edit_description" class="form-label">Beschreibung (optional)</label>
                            <textarea class="form-control" id="edit_description" name="description" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                        <button type="submit" class="btn btn-primary">√Ñnderungen speichern</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container my-5" id="calendar-content"
         hx-get="{% url 'calendar_data' %}?days=7"
         hx-trigger="load, refreshCalendar from:body"
         hx-swap="innerHTML">
        <!-- Loading Placeholder -->
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3 text-muted">Lade Termine...</p>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Handle form submission and modal closing -->
    <script>
        // Validation function to check if end date/time is before start date/time
        function validateDateTime(startDateId, startTimeId, endDateId, endTimeId, isWholeDayId, errorContainerId) {
            const startDateEl = document.getElementById(startDateId);
            const startTimeEl = document.getElementById(startTimeId);
            const endDateEl = document.getElementById(endDateId);
            const endTimeEl = document.getElementById(endTimeId);
            const isWholeDay = document.getElementById(isWholeDayId).checked;
            const errorContainer = document.getElementById(errorContainerId);

            const startDate = startDateEl.value;
            const startTime = startTimeEl.value;
            const endDate = endDateEl.value;
            const endTime = endTimeEl.value;

            // Clear previous error and visual indicators
            errorContainer.innerHTML = '';
            startDateEl.classList.remove('field-error');
            startTimeEl.classList.remove('field-error');
            endDateEl.classList.remove('field-error');
            endTimeEl.classList.remove('field-error');

            // Validate dates are provided
            if (!startDate || !endDate) {
                return true; // Let HTML5 required validation handle this
            }

            // For whole day events, just compare dates
            if (isWholeDay) {
                if (endDate < startDate) {
                    startDateEl.classList.add('field-error');
                    endDateEl.classList.add('field-error');
                    errorContainer.innerHTML = '<div class="alert alert-danger" role="alert">' +
                        '‚ùå Das Enddatum darf nicht vor dem Startdatum liegen.' +
                        '</div>';
                    return false;
                }
                return true;
            }

            // For timed events, compare date and time
            if (startTime && endTime) {
                const startDateTime = new Date(startDate + 'T' + startTime);
                const endDateTime = new Date(endDate + 'T' + endTime);

                if (endDateTime <= startDateTime) {
                    startDateEl.classList.add('field-error');
                    startTimeEl.classList.add('field-error');
                    endDateEl.classList.add('field-error');
                    endTimeEl.classList.add('field-error');
                    errorContainer.innerHTML = '<div class="alert alert-danger" role="alert">' +
                        '‚ùå Der Endzeitpunkt muss nach dem Startzeitpunkt liegen.' +
                        '</div>';
                    return false;
                }
            } else if (endDate < startDate) {
                // If times are not set, at least check dates
                startDateEl.classList.add('field-error');
                endDateEl.classList.add('field-error');
                errorContainer.innerHTML = '<div class="alert alert-danger" role="alert">' +
                    '‚ùå Das Enddatum darf nicht vor dem Startdatum liegen.' +
                    '</div>';
                return false;
            }

            return true;
        }

        // Clear validation errors when user changes fields
        function setupValidationClearOnChange(startDateId, startTimeId, endDateId, endTimeId) {
            const fields = [startDateId, startTimeId, endDateId, endTimeId];

            fields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('change', function() {
                        // Clear error styling from all related fields
                        fields.forEach(id => {
                            const el = document.getElementById(id);
                            if (el) {
                                el.classList.remove('field-error');
                            }
                        });
                    });
                }
            });
        }

        // Handle days selection dropdown
        function updateCalendarDays(days) {
            // Update the text
            document.getElementById('days-count').textContent = days;

            // Use HTMX ajax to fetch new data with updated days parameter
            const baseUrl = '{% url "calendar_data" %}';
            const newUrl = baseUrl + '?days=' + days;

            console.log('[Calendar] Fetching data for ' + days + ' days from: ' + newUrl);

            htmx.ajax('GET', newUrl, {
                target: '#calendar-content',
                swap: 'innerHTML'
            }).then(function() {
                console.log('[Calendar] Data loaded successfully for ' + days + ' days');
            }).catch(function(error) {
                console.error('[Calendar] Error loading data:', error);
            });
        }

        // Set today's date as default for start_date
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('start_date').value = today;
            document.getElementById('end_date').value = today;

            // Setup validation error clearing for create form
            setupValidationClearOnChange('start_date', 'start_time', 'end_date', 'end_time');

            // Setup validation error clearing for edit form
            setupValidationClearOnChange('edit_start_date', 'edit_start_time', 'edit_end_date', 'edit_end_time');

            // Handle days dropdown change
            document.getElementById('days-select').addEventListener('change', function() {
                console.log('Days dropdown changed to:', this.value);
                updateCalendarDays(this.value);
            });

            // Reset create form when modal is closed
            const newAppointmentModal = document.getElementById('newAppointmentModal');
            newAppointmentModal.addEventListener('hidden.bs.modal', function() {
                const form = this.querySelector('form');
                form.reset();

                // Clear any error messages
                document.getElementById('appointment-message').innerHTML = '';

                // Reset dates to today
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('start_date').value = today;
                document.getElementById('end_date').value = today;

                // Clear validation errors
                ['start_date', 'start_time', 'end_date', 'end_time'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.classList.remove('field-error');
                    }
                });
            });

            // Reset edit form when modal is closed
            const editAppointmentModal = document.getElementById('editAppointmentModal');
            editAppointmentModal.addEventListener('hidden.bs.modal', function() {
                const form = this.querySelector('form');
                form.reset();

                // Clear any error messages
                document.getElementById('edit-appointment-message').innerHTML = '';

                // Clear validation errors
                ['edit_start_date', 'edit_start_time', 'edit_end_date', 'edit_end_time'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.classList.remove('field-error');
                    }
                });
            });
        });

        // Intercept form submission for create appointment to validate
        document.addEventListener('htmx:configRequest', function(event) {
            const form = event.detail.elt;

            // Check if this is the create appointment form
            if (form.getAttribute('hx-target') === '#appointment-message') {
                const isValid = validateDateTime(
                    'start_date', 'start_time', 'end_date', 'end_time',
                    'is_whole_day', 'appointment-message'
                );

                if (!isValid) {
                    event.preventDefault();
                    return false;
                }
            }

            // Check if this is the edit appointment form
            if (form.getAttribute('hx-target') === '#edit-appointment-message') {
                const isValid = validateDateTime(
                    'edit_start_date', 'edit_start_time', 'edit_end_date', 'edit_end_time',
                    'edit_is_whole_day', 'edit-appointment-message'
                );

                if (!isValid) {
                    event.preventDefault();
                    return false;
                }
            }
        });

        // Function to show success toast
        function showSuccessToast(message) {
            // Create toast container if it doesn't exist
            let toastContainer = document.getElementById('toast-container');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toast-container';
                toastContainer.className = 'position-fixed top-0 end-0 p-3';
                toastContainer.style.zIndex = '9999';
                document.body.appendChild(toastContainer);
            }

            // Create toast
            const toastId = 'toast-' + Date.now();
            const toastHtml = `
                <div id="${toastId}" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="true" data-bs-delay="5000">
                    <div class="d-flex">
                        <div class="toast-body">
                            ‚úÖ ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `;
            toastContainer.insertAdjacentHTML('beforeend', toastHtml);

            // Show toast
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement);
            toast.show();

            // Remove toast from DOM after it's hidden
            toastElement.addEventListener('hidden.bs.toast', function() {
                toastElement.remove();
            });
        }

        document.body.addEventListener('htmx:afterRequest', function(event) {
            // Check if this was the create appointment form
            if (event.detail.target.id === 'appointment-message') {
                if (event.detail.successful) {
                    const response = JSON.parse(event.detail.xhr.response);
                    if (response.success) {
                        // Close modal immediately
                        const modalElement = document.getElementById('newAppointmentModal');
                        const modal = bootstrap.Modal.getInstance(modalElement);
                        if (modal) {
                            modal.hide();
                        }

                        // Clean up modal backdrop and body classes
                        setTimeout(() => {
                            const backdrops = document.querySelectorAll('.modal-backdrop');
                            backdrops.forEach(backdrop => backdrop.remove());
                            document.body.classList.remove('modal-open');
                            document.body.style.overflow = '';
                            document.body.style.paddingRight = '';
                        }, 300);

                        // Show success toast
                        showSuccessToast(response.message);

                        // Reload calendar data
                        document.body.dispatchEvent(new Event('refreshCalendar'));
                    } else {
                        // Show error message in modal
                        event.detail.target.innerHTML = '<div class="alert alert-danger" role="alert">' +
                            '‚ùå Fehler: ' + response.error +
                            '</div>';
                    }
                } else {
                    // Network error - show in modal
                    event.detail.target.innerHTML = '<div class="alert alert-danger" role="alert">' +
                        '‚ùå Netzwerkfehler beim Erstellen des Termins' +
                        '</div>';
                }
            }
        });

        // Handle whole-day checkbox
        document.getElementById('is_whole_day').addEventListener('change', function() {
            const startTime = document.getElementById('start_time');
            const endTime = document.getElementById('end_time');

            if (this.checked) {
                startTime.disabled = true;
                endTime.disabled = true;
                startTime.value = '';
                endTime.value = '';
            } else {
                startTime.disabled = false;
                endTime.disabled = false;
            }
        });

        // Auto-fill end date when start date changes
        document.getElementById('start_date').addEventListener('change', function() {
            const endDate = document.getElementById('end_date');
            const startDateValue = this.value;

            // Update end date if:
            // 1. No end date is selected, OR
            // 2. End date is before start date
            if (!endDate.value || endDate.value < startDateValue) {
                endDate.value = startDateValue;
            }
        });

        // Set minutes to 00 when user starts selecting a time (only if no value set)
        function setupTimeInputDefaults(timeInputId) {
            const timeInput = document.getElementById(timeInputId);
            let hasBeenSet = false;

            timeInput.addEventListener('focus', function() {
                // Only set default if field is empty
                if (!this.value && !hasBeenSet) {
                    const now = new Date();
                    const hours = String(now.getHours()).padStart(2, '0');
                    this.value = hours + ':00';
                    hasBeenSet = true;
                }
            });
        }

        // Apply to both start and end time inputs
        setupTimeInputDefaults('start_time');
        setupTimeInputDefaults('end_time');

        // Handle delete button clicks with confirmation
        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('delete-appointment-btn') ||
                event.target.closest('.delete-appointment-btn')) {

                const button = event.target.classList.contains('delete-appointment-btn')
                    ? event.target
                    : event.target.closest('.delete-appointment-btn');

                const appointmentId = button.dataset.appointmentId;
                const appointmentName = button.dataset.appointmentName;
                const calendarName = button.dataset.calendarName;

                // Show confirmation dialog
                if (!confirm(`M√∂chten Sie den Termin "${appointmentName}" wirklich l√∂schen?`)) {
                    return;
                }

                // Disable button during deletion
                button.disabled = true;
                button.innerHTML = '‚è≥ L√∂schen...';

                // Create form data
                const formData = new FormData();
                formData.append('appointment_id', appointmentId);
                formData.append('calendar_name', calendarName);

                // Get CSRF token
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

                // Send delete request
                fetch('{% url "calendar_delete" %}', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken
                    },
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Show success toast
                        showSuccessToast(data.message);

                        // Refresh calendar immediately
                        document.body.dispatchEvent(new Event('refreshCalendar'));
                    } else {
                        // Show error
                        alert('Fehler beim L√∂schen: ' + data.error);
                        button.disabled = false;
                        button.innerHTML = 'üóëÔ∏è L√∂schen';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Netzwerkfehler beim L√∂schen des Termins');
                    button.disabled = false;
                    button.innerHTML = 'üóëÔ∏è L√∂schen';
                });
            }

            // Handle edit button clicks
            if (event.target.classList.contains('edit-appointment-btn') ||
                event.target.closest('.edit-appointment-btn')) {

                const button = event.target.classList.contains('edit-appointment-btn')
                    ? event.target
                    : event.target.closest('.edit-appointment-btn');

                // Get appointment data from button attributes
                const appointmentId = button.dataset.appointmentId;
                const appointmentName = button.dataset.appointmentName;
                const calendarName = button.dataset.calendarName;
                const startDate = button.dataset.startDate;
                const startTime = button.dataset.startTime;
                const endDate = button.dataset.endDate;
                const endTime = button.dataset.endTime;
                const isWholeDay = button.dataset.isWholeDay === 'true';

                // Populate edit form
                document.getElementById('edit_appointment_id').value = appointmentId;
                document.getElementById('edit_original_calendar_name').value = calendarName;
                document.getElementById('edit_calendar').value = calendarName;
                document.getElementById('edit_event_name').value = appointmentName;
                document.getElementById('edit_start_date').value = startDate;
                document.getElementById('edit_start_time').value = startTime;
                document.getElementById('edit_end_date').value = endDate;
                document.getElementById('edit_end_time').value = endTime;
                document.getElementById('edit_is_whole_day').checked = isWholeDay;

                // Handle whole-day state
                const editStartTime = document.getElementById('edit_start_time');
                const editEndTime = document.getElementById('edit_end_time');
                if (isWholeDay) {
                    editStartTime.disabled = true;
                    editEndTime.disabled = true;
                } else {
                    editStartTime.disabled = false;
                    editEndTime.disabled = false;
                }

                // Show edit modal
                const editModal = new bootstrap.Modal(document.getElementById('editAppointmentModal'));
                editModal.show();
            }
        });

        // Handle edit form whole-day checkbox
        document.getElementById('edit_is_whole_day').addEventListener('change', function() {
            const startTime = document.getElementById('edit_start_time');
            const endTime = document.getElementById('edit_end_time');

            if (this.checked) {
                startTime.disabled = true;
                endTime.disabled = true;
                startTime.value = '';
                endTime.value = '';
            } else {
                startTime.disabled = false;
                endTime.disabled = false;
            }
        });

        // Handle edit form submission response
        document.body.addEventListener('htmx:afterRequest', function(event) {
            if (event.detail.target.id === 'edit-appointment-message') {
                if (event.detail.successful) {
                    const response = JSON.parse(event.detail.xhr.response);
                    if (response.success) {
                        // Close modal immediately
                        const modalElement = document.getElementById('editAppointmentModal');
                        const modal = bootstrap.Modal.getInstance(modalElement);
                        if (modal) {
                            modal.hide();
                        }

                        // Clean up modal backdrop and body classes
                        setTimeout(() => {
                            const backdrops = document.querySelectorAll('.modal-backdrop');
                            backdrops.forEach(backdrop => backdrop.remove());
                            document.body.classList.remove('modal-open');
                            document.body.style.overflow = '';
                            document.body.style.paddingRight = '';
                        }, 300);

                        // Show success toast
                        showSuccessToast(response.message);

                        // Reload calendar data
                        document.body.dispatchEvent(new Event('refreshCalendar'));
                    } else {
                        // Show error message in modal
                        event.detail.target.innerHTML = '<div class="alert alert-danger" role="alert">' +
                            '‚ùå Fehler: ' + response.error +
                            '</div>';
                    }
                } else {
                    // Network error
                    event.detail.target.innerHTML = '<div class="alert alert-danger" role="alert">' +
                        '‚ùå Netzwerkfehler beim Aktualisieren des Termins' +
                        '</div>';
                }
            }
        });
    </script>
{% endblock %}
