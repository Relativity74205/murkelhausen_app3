{% extends "base.html" %}

{% block title %}Murkelhausen Family Intranet{% endblock %}

{% block nav_home %}active{% endblock %}

{% block extra_css %}
<!-- HTMX -->
<script src="https://unpkg.com/htmx.org@2.0.1"></script>

<style>
    .hero-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 4rem 0;
    }
    .feature-card {
        transition: transform 0.2s, box-shadow 0.2s;
        height: 100%;
        cursor: pointer;
        text-decoration: none;
        color: inherit;
        display: block;
    }
    .feature-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
        color: inherit;
        text-decoration: none;
    }
    .navbar-brand {
        font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}

    <!-- Hero Section -->
    <section class="hero-section">
        <div class="container text-center">
            <h1 class="display-4 mb-4">Murkelhausen Family</h1>
        </div>
    </section>

    <!-- Main Content -->
    <div id="main-content">
        <!-- Features Section -->
        <section class="py-5">
            <div class="container">
                <div class="row g-4 justify-content-center">
                    <!-- Calendar Feature -->
                    <div class="col-md-4">
                        <a href="{% url 'calendar' %}" class="card feature-card shadow-sm">
                            <div class="card-body text-center p-4">
                                <div class="mb-3">
                                    <i class="display-4">üìÖ</i>
                                </div>
                                <h5 class="card-title">Familienkalender</h5>
                                <p class="card-text">
                                    Termine aller Familienkalender f√ºr die n√§chsten 7 Tage
                                </p>
                            </div>
                        </a>
                    </div>

                    <!-- Work Calendar Feature -->
                    <div class="col-md-4">
                        <a href="{% url 'work_calendar' %}" class="card feature-card shadow-sm">
                            <div class="card-body text-center p-4">
                                <div class="mb-3">
                                    <i class="display-4">üíº</i>
                                </div>
                                <h5 class="card-title">Arbeitskalender</h5>
                                <p class="card-text">
                                    Arbeitstermine aus Outlook Kalender f√ºr die n√§chste Woche
                                </p>
                            </div>
                        </a>
                    </div>

                    <div class="col-md-4">
                        <a href="{% url 'football_games' %}" class="card feature-card shadow-sm">
                            <div class="card-body text-center p-4">
                                <div class="mb-3">
                                    <i class="display-4">‚öΩ</i>
                                </div>
                                <h5 class="card-title">Fu√üball</h5>
                                <p class="card-text">
                                    Fu√üball-Spielpl√§ne des VfB Speldorfs (E2-Junioren und Heimspiele)
                                </p>
                            </div>
                        </a>
                    </div>

                    <!-- Handball Feature -->
                    <div class="col-md-4">
                        <a href="{% url 'handball_games' %}" class="card feature-card shadow-sm">
                            <div class="card-body text-center p-4">
                                <div class="mb-3">
                                    <i class="display-4">ü§æ</i>
                                </div>
                                <h5 class="card-title">Handball</h5>
                                <p class="card-text">
                                    Handball-Spielpl√§ne des DJK Saarns (D-Jugend und Erste Herren)
                                </p>
                            </div>
                        </a>
                    </div>

                    <!-- M√ºlltermine Feature -->
                    <div class="col-md-4">
                        <a href="{% url 'muelltermine' %}" class="card feature-card shadow-sm">
                            <div class="card-body text-center p-4">
                                <div class="mb-3">
                                    <i class="display-4">üóëÔ∏è</i>
                                </div>
                                <h5 class="card-title">M√ºlltermine</h5>
                                <p class="card-text">
                                    Abfuhrtermine f√ºr Restm√ºll, Papier, Gelbe Tonne und Biotonne
                                </p>
                            </div>
                        </a>
                    </div>

                    <!-- Vertretungsplan Feature -->
                    <div class="col-md-4">
                        <a href="{% url 'vertretungsplan' %}" class="card feature-card shadow-sm">
                            <div class="card-body text-center p-4">
                                <div class="mb-3">
                                    <i class="display-4">üìö</i>
                                </div>
                                <h5 class="card-title">Vertretungsplan</h5>
                                <p class="card-text">
                                    Vertretungsplan f√ºr Mattis am Gymnasium Broich
                                </p>
                            </div>
                        </a>
                    </div>

                    <!-- Weather Feature -->
                    <div class="col-md-4">
                        <a href="{% url 'weather' %}" class="card feature-card shadow-sm">
                            <div class="card-body text-center p-4">
                                <div class="mb-3">
                                    <i class="display-4">üå§Ô∏è</i>
                                </div>
                                <h5 class="card-title">Wetter</h5>
                                <p class="card-text">
                                    Wetterdaten f√ºr M√ºlheim (OpenWeatherMap)
                                </p>
                            </div>
                        </a>
                    </div>

                </div>
            </div>
        </section>

        <!-- Pi-hole Control Section -->
        <section class="py-4 bg-light">
            <div class="container">
                <div class="row justify-content-center">
                    <div class="col-md-6">
                        <div class="card shadow-sm">
                            <div class="card-body text-center p-4">
                                <h5 class="card-title mb-3">üõ°Ô∏è Pi-hole Control</h5>
                                <button
                                    id="pihole-disable-btn"
                                    class="btn btn-warning"
                                    hx-post="{% url 'pihole_disable' %}"
                                    hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                                    hx-swap="none"
                                    hx-indicator="#pihole-spinner"
                                >
                                    Tempor√§r DNS blocking deaktivieren (5 Minuten)
                                </button>
                                <div id="pihole-spinner" class="htmx-indicator spinner-border spinner-border-sm ms-2" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <div id="pihole-message" class="mt-3"></div>
                                <div id="pihole-timer" class="mt-3"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Pi-hole HTMX Response Handler -->
    <script>
        let timerInterval = null;

        function startCountdown(seconds) {
            const timerDiv = document.getElementById('pihole-timer');

            // Clear any existing timer
            if (timerInterval) {
                clearInterval(timerInterval);
            }

            let remainingSeconds = seconds;

            function updateTimer() {
                if (remainingSeconds <= 0) {
                    clearInterval(timerInterval);
                    timerDiv.innerHTML = '';
                    return;
                }

                const minutes = Math.floor(remainingSeconds / 60);
                const secs = remainingSeconds % 60;
                const timeString = `${minutes}:${secs.toString().padStart(2, '0')}`;

                timerDiv.innerHTML = '<div class="alert alert-info" role="alert">' +
                    '<strong>‚è±Ô∏è Blocking deaktiviert:</strong> Wieder-Aktivierung in ' + timeString + ' Minuten'
                    '</div>';

                remainingSeconds--;
            }

            // Update immediately
            updateTimer();

            // Then update every second
            timerInterval = setInterval(updateTimer, 1000);
        }

        // Fetch current status on page load
        function fetchPiholeStatus() {
            fetch("{% url 'pihole_status' %}")
                .then(response => response.json())
                .then(data => {
                    console.log('Pi-hole status:', data);
                    if (data.success && !data.blocking && data.timer && data.timer > 0) {
                        console.log('Starting countdown with', data.timer, 'seconds');
                        startCountdown(data.timer);
                    } else {
                        console.log('Not starting countdown. blocking:', data.blocking, 'timer:', data.timer);
                    }
                })
                .catch(error => {
                    console.error('Failed to fetch Pi-hole status:', error);
                });
        }

        // Load status when page loads
        document.addEventListener('DOMContentLoaded', fetchPiholeStatus);

        document.body.addEventListener('htmx:afterRequest', function(event) {
            if (event.detail.target.id === 'pihole-disable-btn') {
                const messageDiv = document.getElementById('pihole-message');
                const timerDiv = document.getElementById('pihole-timer');

                if (event.detail.successful) {
                    const response = JSON.parse(event.detail.xhr.response);
                    if (response.success) {
                        messageDiv.innerHTML = '<div class="alert alert-success" role="alert">' +
                            '<i>‚úÖ</i> ' + response.message +
                            '</div>';

                        // Clear message after 10 seconds
                        setTimeout(() => {
                            messageDiv.innerHTML = '';
                        }, 10000);

                        // Start countdown timer if we have a timer value
                        if (response.timer && response.timer > 0) {
                            startCountdown(response.timer);
                        }
                    } else {
                        messageDiv.innerHTML = '<div class="alert alert-danger" role="alert">' +
                            '<i>‚ùå</i> Error: ' + response.error +
                            '</div>';
                        timerDiv.innerHTML = '';
                    }
                } else {
                    messageDiv.innerHTML = '<div class="alert alert-danger" role="alert">' +
                        '<i>‚ùå</i> Failed to connect to Pi-hole server' +
                        '</div>';
                    timerDiv.innerHTML = '';
                }
            }
        });
    </script>

    <!-- HTMX Loading Indicator -->
    <div class="htmx-indicator position-fixed top-50 start-50 translate-middle" style="z-index: 9999;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <style>
        .htmx-indicator {
            opacity: 0;
            transition: opacity 200ms ease-in;
        }
        .htmx-request .htmx-indicator {
            opacity: 1;
        }
    </style>
{% endblock %}